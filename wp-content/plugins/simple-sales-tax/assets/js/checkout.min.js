!function(n,d,a){n(function(){n("#sst-certificates");var e=n("#sst-certificates tbody"),t=a.template("sst-certificate-row"),c=a.template("sst-certificate-row-blank"),i=Backbone.Model.extend({certificates:{},selected:""}),o=new(Backbone.View.extend({rowTemplate:t,initialize:function(){this.listenTo(this.model,"change:certificates",this.render),n(document.body).on("click",".sst-certificate-add",{view:this},this.onAddCertificate),n(document.body).on("wc_backbone_modal_response",this.onAddCertificateSubmitted)},render:function(){var e=_.indexBy(this.model.get("certificates"),"CertificateID"),t=this.model.get("selected"),i=this,a=1;this.$el.empty(),_.size(e)?(n.each(e,function(e,t){t.Index=a++,i.$el.append(i.rowTemplate(t))}),i.$el.find(".sst-certificate-delete").on("click",{view:this},this.onDeleteRow),i.$el.find(".sst-certificate-view").on("click",{view:this},this.onViewCertificate),i.$el.find('input[name="certificate_id"]').on("change",this.updateCheckout),t?n('input[name="certificate_id"][value="'+t+'"]').prop("checked",!0):(t=n('input[name="certificate_id"]').first())&&(t.prop("checked",!0),this.model.set("selected",t.val()))):i.$el.append(c)},block:function(){n(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){n(this.el).unblock()},updateCheckout:function(e){n(document.body).trigger("update_checkout")},onDeleteRow:function(e){var i=e.data.view,t=i.model,a=(_.indexBy(t.get("certificates"),"CertificateID"),i.model.get("selected")),c=n(this).closest("tr").data("id");e.preventDefault(),confirm(d.strings.delete_certificate)&&(i.block(),n.post(d.ajaxurl+"?action=sst_delete_certificate",{nonce:d.delete_certificate_nonce,certificate_id:c},function(e,t){i.unblock(),"success"===t&&e.success?(a==c&&o.model.set("selected",""),o.model.set("certificates",e.data.certificates),o.model.trigger("change:certificates"),o.updateCheckout()):alert(d.strings.delete_failed+": "+e.data)},"json"))},onViewCertificate:function(e){var t=e.data.view.model,t=_.indexBy(t.get("certificates"),"CertificateID")[n(this).closest("tr").data("id")];e.preventDefault(),t&&(t.SinglePurchase?t.backgroundImage=d.images.single_cert:t.backgroundImage=d.images.blanket_cert,n(this).SSTBackboneModal({template:"sst-modal-view-certificate",variable:t}))},onAddCertificate:function(e){var t=e.data.view;e.preventDefault(),n(this).SSTBackboneModal({template:"sst-modal-add-certificate",variable:{CertificateID:"new-"+(new Date).getTime()},callback:t.validateAddCertificate})},validateAddCertificate:function(e,t,i){e=n(e.target).closest(".wc-backbone-modal").find("form");return e.find(".validate-required").removeClass("woocommerce-invalid-required-field woocommerce-invalid"),e.find(".validate-required").each(function(){""===n(this).find("input, select, textarea").val()&&n(this).addClass("woocommerce-invalid-required-field woocommerce-invalid")}),0===e.find(".woocommerce-invalid").length},onAddCertificateSubmitted:function(e,t,i){"sst-modal-add-certificate"===t&&(o.block(),n.post(d.ajaxurl+"?action=sst_add_certificate",{nonce:d.add_certificate_nonce,certificate:i,form_data:n("form.woocommerce-checkout").serialize()},function(e,t){o.unblock(),"success"===t&&e.success?(o.model.set("selected",e.data.certificate_id),o.model.set("certificates",e.data.certificates),o.model.trigger("change:certificates"),o.updateCheckout()):alert(d.strings.add_failed+": "+e.data)},"json"))}}))({model:new i({certificates:d.certificates,selected:d.selected}),el:e});o.render(),n(document).on("change","#tax_exempt_checkbox",function(){n("#tax_exempt_checkbox").is(":checked")?n("#tax_details").fadeIn():n("#tax_details").hide(),n(document.body).trigger("update_checkout")}),n(document).on("change","#PurchaserBusinessType",function(){var e=n("#business-type-other_field");"Other"==n(this).val()?e.addClass("validate-required").show():e.removeClass("validate-required").hide()}),n(document).on("change","#TaxType",function(){var e=n("#issuing-state_field");"StateIssued"==n(this).val()?e.addClass("validate-required").show():e.removeClass("validate-required").hide()}),n(document).on("change","#PurchaserExemptionReason",function(){var e=n("#exempt-other-reason_field"),t=e.find("label"),i=n(this).val();""!==i?(e.addClass("validate-required").show(),t.text({FederalGovernmentDepartment:"Dept. Name",StateOrLocalGovernmentName:"Govt. Name",TribalGovernmentName:"Tribe Name",ForeignDiplomat:"Diplomat ID",CharitableOrganization:"Organization ID",ReligiousOrEducationalOrganization:"Organization ID",Resale:"Resale ID",AgriculturalProduction:"Agricultural Prod. ID",IndustrialProductionOrManufacturing:"Production ID",DirectPayPermit:"Permit ID",DirectMail:"Direct Mail ID",Other:"Please explain"}[i])):e.removeClass("validate-required").hide()}),n(document).on("input",".sst-input",function(e){n(this).closest(".form-row").removeClass("woocommerce-invalid woocommerce-invalid-required-field woocommerce-invalid-email woocommerce-validated")}),n("#tax_exempt_checkbox").change()})}(jQuery,SSTCertData,wp);